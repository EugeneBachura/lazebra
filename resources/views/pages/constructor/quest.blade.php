
<link rel="stylesheet" href="{{ url('constructor-app/css/magnific-popup.css') }}">
<link rel="stylesheet" href="{{ url('constructor-app/css/constructor.css') }}">
<link rel="stylesheet" href="{{ url('constructor-app/css/quest.css') }}">

<link rel="stylesheet" href="{{ url('constructor-app/css/fonts.css') }}">

<!--<a href="#model" class="constructor__popup-model" data-name="informationAvto">
    Модель
</a>-->

<div id="model" class="open_popup" style="width: 1264px; margin: auto; position: relative">
    <h2>Модель вашего автомобиля</h2>
    <div class="marka_popup">
        <div class="marka_popup-item">
            <button class="0"><img src="https://modelscan.ru/pic/brands/89ec2a.png" alt=""><p>Audi</p></button>
        </div>
        <div class="marka_popup-item">
            <button class="1"><img src="https://modelscan.ru/pic/brands/8cbe27.webp" alt=""><p>BMW</p></button>
        </div>
        <div class="marka_popup-item">
            <button class="2"><img src="https://modelscan.ru/pic/brands/478ef8.webp" alt=""><p>Chery</p></button>
        </div>
        <div class="marka_popup-item">
            <button class="3"><img src="https://modelscan.ru/pic/brands/c2c2e4.png" alt=""><p>Chevrolet</p></button>
        </div>
        <div class="marka_popup-item">
            <button class="4"><img src="https://modelscan.ru/pic/brands/f64410.png" alt=""><p>Citroen</p></button>
        </div>
        <div class="marka_popup-item">
            <button class="5"><img src="https://modelscan.ru/pic/brands/f9cf6a.png" alt=""><p>Daewoo</p></button>
        </div>
        <div class="marka_popup-item">
            <button class="6"><img src="https://modelscan.ru/pic/brands/30ee51.png" alt=""><p>Datsun</p></button>
        </div>
        <div class="marka_popup-item">
            <button class="7"><img src="https://modelscan.ru/pic/brands/683177.png" alt=""><p>Fiat</p></button>
        </div>
        <div class="marka_popup-item">
            <button class="8"><img src="https://modelscan.ru/pic/brands/232850.png" alt=""><p>Ford</p></button>
        </div>
        <div class="marka_popup-item"><button class="9"><img src="https://modelscan.ru/pic/brands/4c1133.png" alt=""><p>Geely</p></button></div><div class="marka_popup-item"><button class="10"><img src="https://modelscan.ru/pic/brands/60f9fb.jpg" alt=""><p>Haval</p></button></div><div class="marka_popup-item"><button class="11"><img src="https://modelscan.ru/pic/brands/8295fe.webp" alt=""><p>Honda</p></button></div><div class="marka_popup-item"><button class="12"><img src="https://modelscan.ru/pic/brands/e3da77.png" alt=""><p>Hyundai</p></button></div><div class="marka_popup-item"><button class="13"><img src="https://modelscan.ru/pic/brands/4eb297.png" alt=""><p>Jeep</p></button></div><div class="marka_popup-item"><button class="14"><img src="https://modelscan.ru/pic/brands/8ed1f8.png" alt=""><p>KIA</p></button></div><div class="marka_popup-item"><button class="15"><img src="https://modelscan.ru/pic/brands/8590f9.webp" alt=""><p>Lada</p></button></div><div class="marka_popup-item"><button class="16"><img src="https://modelscan.ru/pic/brands/35b1df.png" alt=""><p>Land Rover</p></button></div><div class="marka_popup-item"><button class="17"><img src="https://modelscan.ru/pic/brands/c16168.webp" alt=""><p>Lexus</p></button></div><div class="marka_popup-item"><button class="18"><img src="https://modelscan.ru/pic/brands/815792.webp" alt=""><p>Mazda</p></button></div><div class="marka_popup-item"><button class="19"><img src="https://modelscan.ru/pic/brands/aa361c.png" alt=""><p>Mercedes</p></button></div><div class="marka_popup-item"><button class="20"><img src="https://modelscan.ru/pic/brands/2401bd.png" alt=""><p>Mitsubishi</p></button></div><div class="marka_popup-item"><button class="21"><img src="https://modelscan.ru/pic/brands/a13533.png" alt=""><p>Nissan</p></button></div><div class="marka_popup-item"><button class="22"><img src="https://modelscan.ru/pic/brands/08b8e0.png" alt=""><p>Opel</p></button></div><div class="marka_popup-item"><button class="23"><img src="https://modelscan.ru/pic/brands/7433d0.webp" alt=""><p>Peugeot</p></button></div><div class="marka_popup-item"><button class="24"><img src="https://modelscan.ru/pic/brands/becbd8.png" alt=""><p>Pontiac</p></button></div><div class="marka_popup-item"><button class="25"><img src="https://modelscan.ru/pic/brands/254c3e.png" alt=""><p>Ravon</p></button></div><div class="marka_popup-item"><button class="26"><img src="https://modelscan.ru/pic/brands/e8a8bb.webp" alt=""><p>Renault</p></button></div><div class="marka_popup-item"><button class="27"><img src="https://modelscan.ru/pic/brands/22cfc1.png" alt=""><p>Rover</p></button></div><div class="marka_popup-item"><button class="28"><img src="https://modelscan.ru/pic/brands/54113d.png" alt=""><p>Skoda</p></button></div><div class="marka_popup-item"><button class="29"><img src="https://modelscan.ru/pic/brands/f5affb.png" alt=""><p>Ssang Yong</p></button></div><div class="marka_popup-item"><button class="30"><img src="https://modelscan.ru/pic/brands/b9b972.png" alt=""><p>Subaru</p></button></div><div class="marka_popup-item"><button class="31"><img src="https://modelscan.ru/pic/brands/a52c32.png" alt=""><p>Suzuki</p></button></div><div class="marka_popup-item"><button class="32"><img src="https://modelscan.ru/pic/brands/e0ee5e.webp" alt=""><p>Toyota</p></button></div><div class="marka_popup-item"><button class="33"><img src="https://modelscan.ru/pic/brands/1cc9a6.png" alt=""><p>Volkswagen</p></button></div><div class="marka_popup-item"><button class="34"><img src="https://modelscan.ru/pic/brands/f13375.png" alt=""><p>ГАЗ</p></button></div><div class="marka_popup-item"><button class="35"><img src="https://modelscan.ru/pic/brands/4b3208.png" alt=""><p>УАЗ</p></button></div>
    </div>
    <!--<button type="button" class="mfp-close">Отмена</button>-->
</div>


<script src="{{ url('constructor-app/js/jquery-3.4.0.min.js') }}"></script>
<script src="{{ url('constructor-app/js/jquery.magnific-popup.min.js') }}"></script>
<script>
    /*$('.constructor__popup-model').magnificPopup({
        type: 'inline'
    });*/

    let model = [];
    let dataRequest = [];
    let dataConstructor;
    $.ajax({
        type: 'GET',
        url: "https://modelscan.ru/api/brands",
        dataType: "json",
        success: function(data) {
            displayInformation(data);
        }
    });

    function getDataInfo(name){
        $.ajax({
            type: 'GET',
            url: "https://modelscan.ru/api/"+name+"",
            dataType: "json",
            success: function(data) {
                displayInformation(data);
            }
        });
    }
    function displayInformation(data){
        model = data;
        $("div.marka_popup-item").remove();
        $.each(data, function( key, value ) {
            let img = value.photo !== undefined ? value.photo : '/img/stub.webp';
            $('.marka_popup').append('<div class="marka_popup-item"><button class="'+key+'"><img src="https://modelscan.ru'+img+'" alt=""><p>'+value.name+'</p></button></div>');
        })
    }
    function modelTypeRequest( active){
        let text = $(active).find('p').text();
        dataRequest.push(model.find( item =>  item.name === text));
        console.log(dataRequest);
        console.log(dataRequest.length);
        switch (dataRequest.length) {
            case 1:{
                setTimeout( function() {getDataInfo('models/'+dataRequest[0].name);}, 500);
                setTimeout( function() {$('.marka_popup').addClass('marka_popup1');}, 500);
                setTimeout( function() {$('.mfp-wrap').addClass('loading');}, 500);
                setTimeout( function() {$('.mfp-wrap').removeClass('loading')}, 2000);
                break;
            }
            case 2:{
                setTimeout( function() {getDataInfo('generations/'+dataRequest[0].name+'/'+dataRequest[1]._id);}, 500);
                break;
            }
            case 3:{
                //setTimeout( function() {getDataInfo('gen_quest/'+dataRequest[0].name+'/'+dataRequest[1]._id+'/'+dataRequest[2]._id);}, 500);
                //break;
            }
            case 4:{
                //setTimeout( function() {getDataInfo('answers/'+dataRequest[0].name+'/'+dataRequest[1]._id+'/'+dataRequest[2]._id+'/'+dataRequest[3]._id);}, 500);
                //break;
            }
            case 5:{
                /*$('.marka_popup').removeClass('marka_popup1');
                $('.mfp-content').hide();
                let information = dataRequest[0].name+' '+dataRequest[1].name+' '+dataRequest[2].name+' '+dataRequest[3].name+' '+dataRequest[4].name;
                $("[data-name='informationAvto']").text(information.substr(0, 40)+'...');
                getDataInfo('brands');
                model.splice(0, model.length);
                dataConstructor = JSON.parse(JSON.stringify(dataRequest))
                console.log(dataRequest);
                dataRequest.splice(0, dataRequest.length);
                $.magnificPopup.close();
                price();
                break;*/
            }
        }
    }

    let arrayQuest = [];
    let arrayQuestText = [];
    let arrayAnswer = [];
    let numbQuest = 0;
    let numbAnswer = 0;
    let arrayReturnAnswer = [];

    $('.marka_popup').on('click', '.answ', function () {
        let text = $(this).find('p').text();
        arrayReturnAnswer.push(text);
        arrayReturnAnswerID.push($(this).data('id'));
        console.log($(this).data('id'));
    });
    $('.marka_popup').on('click', '.marka_popup-item', function () {
        if (dataRequest.length < 1) {
            arrayQuest = [];
            arrayAnswer = [];
            arrayQuestID = [];
            //arrayAnswerID = [];
            numbQuest = 0;
            numbAnswer = 0;
            arrayReturnAnswer = [];
            arrayReturnAnswerID = [];
        };
        if (dataRequest.length == 0) {
            $('.open_popup h2').html('Выбор модели');
        }
        if (dataRequest.length == 1) {
            $('.open_popup h2').html('Поколение вашего автомобиля?');
        }
    if(dataRequest.length < 2) {
            modelTypeRequest(this);
        }
        else{
            if ( numbQuest == 0 ) { 
                let text = $(this).find('p').text();
                dataRequest.push(model.find( item =>  item.name === text));
                console.log(dataRequest);
                getQuests();
                return;
            };
            
            $("div.marka_popup-item").remove();
            /*if (arrayReturnAnswer.length == numbQuest) {*/
            if (arrayQuest.length <= numbAnswer) {
                console.log('arrayQuest',arrayQuest);
                console.log('arrayAnswer',arrayAnswer);
                $('.marka_popup').removeClass('marka_popup1');
                $('.mfp-content').hide();
                //let information = dataRequest[0].name+' '+dataRequest[1].name+' '+dataRequest[2].name;
                let link = 'http://order.lazebra.ru/cabinet#/cabinet/orders/create?article_id='+dataRequest[0].name+'_'+dataRequest[1].name+'_'+dataRequest[2].name;
                for (let index = 0; index < numbQuest ; index++) {
                    link = link+'_'+arrayQuestID[index].substr(arrayReturnAnswerID[index].length - 3)+'-'+arrayReturnAnswerID[index].substr(arrayReturnAnswerID[index].length - 3);
                    console.log(arrayQuestID[index]+'-'+arrayReturnAnswerID[index]);
                    console.log(link);
                };
                //$("[data-name='informationAvto']").text(information.substr(0, 40)+'...');
                //input auto
                /*$("#auto1").val(dataRequest[0].name);
                $("#auto2").val(dataRequest[1].name);
                $("#auto3").val(dataRequest[2].name);
                $("#auto4").val(arrayQuest);
                $("#auto5").val(arrayAnswer);*/

                //$('.constructor__user_form-auto').text(information);
                //getDataInfo('brands');
                model.splice(0, model.length);
                dataConstructor = JSON.parse(JSON.stringify(dataRequest))
                //console.log(dataRequest);
                dataRequest.splice(0, dataRequest.length);
                let html_link = '<a href="'+link+'" class="sub-btn" >Заказать</a>';
                $('.open_popup h2').html(" ");
                $('.marka_popup').append(html_link);
                /*$.magnificPopup.close();
                price();*/
                return;
            };

            getAnsw(arrayQuestID[numbQuest]);
            $('.open_popup h2').html(arrayQuestText[numbQuest]);
            numbQuest++; 
            /*if (numbQuest == numbAnswer) { 
                //$('.marka_popup').append(arrayQuest[numbQuest]);  
                numbQuest++; 
            }   else { getAnsw(this); };*/
        };
    });




    function getQuests() {
        let name = 'gen_quest/'+dataRequest[0].name+'/'+dataRequest[1]._id+'/'+dataRequest[2]._id;
            $.ajax({
                type: 'GET',
                url: "https://modelscan.ru/api/"+name+"",
                dataType: "json",
                success: function(data) {
                    displayQuest(data);
                    model = data;
                    console.log('getQuests',data);
                }
            });
        };
    function getAnsw(e) {
                    //let ans = model.find( item =>  item.name === $(e).find('p').text());
                    //let ans = e;
                    name = 'answers/'+dataRequest[0].name+'/'+dataRequest[1]._id+'/'+dataRequest[2]._id+'/'+e;
                    $.ajax({
                        type: 'GET',
                        url: "https://modelscan.ru/api/"+name+"",
                        dataType: "json",
                        success: function(data) {
                            displayAnsw(data);
                            console.log('getAnsw',data);
                        }
                    });
    };
    function displayQuest(data){
        $.each(data, function( key, value ) {
            let img = value.photo !== undefined ? value.photo : '/img/stub.webp';
            let push = '<div class="marka_popup-item"><button class="'+key+'"><img src="https://modelscan.ru'+img+'" alt=""><p>'+value.name+'</p></button></div>';
            arrayQuestText.push(value.name);
            arrayQuestID.push(value._id);
            arrayQuest.push(push);
        })
        $("div.marka_popup-item").remove();
        //$('.marka_popup').append(arrayQuest[numbQuest]); 
        $('.open_popup h2').html(arrayQuestText[numbQuest]);
        console.log('arrayQuest[numbQuest]',arrayQuest[numbQuest]);
        //$('.marka_popup .marka_popup-item').click();
        console.log('arrayQuestID',arrayQuestID[numbQuest]);
        getAnsw(arrayQuestID[numbQuest]);
        numbQuest++;
    }
    function displayAnsw(data){
        let answer = '';
        $.each(data, function( key, value ) {
            let img = value.photo !== undefined ? value.photo : '/img/stub.webp';
            answer = answer + '<div class="marka_popup-item answ" data-id="'+value._id+'"><button class="'+key+'"><img src="https://modelscan.ru'+img+'" alt=""><p>'+value.name+'</p></button></div>';
            //arrayAnswerID.push(value._id);
        });
        arrayAnswer.push(answer);

        $("div.marka_popup-item").remove();
        $('.marka_popup').append(arrayAnswer[numbAnswer]);
        numbAnswer++;

    }

    $('.open_popup').on('click', '.mfp-close',  function () {
        $('.marka_popup').removeClass('marka_popup1');
        $('.marka_popup').removeClass('marka_popup4');  
        $('.mfp-content').hide();
        getDataInfo('brands');
        model.splice(0, model.length);
        dataRequest.splice(0, dataRequest.length);
    });
</script>